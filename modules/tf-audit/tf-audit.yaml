# Copyright 2023 EPAM Systems
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

steps:
  - name: gcr.io/cloud-builders/gcloud
    args:
      - '-c'
      - |
        git clone https://$$GIT_TOKEN@github.com/epam/gcp-ci-cd-accelerator
        cd tf
        git checkout $_BASE_BRANCH && git checkout $_HEAD_BRANCH
        
        touch dir_list.txt

        for dir in $(git log $(git merge-base $_BASE_BRANCH $_HEAD_BRANCH)\.\.$_HEAD_BRANCH --name-only --pretty=format: $_HEAD_BRANCH); do
          [ -f $(dirname $dir)/.auditignore ] && continue
          ls $(dirname $dir)/*.tf >/dev/null 2>&1 || continue
          dirname $dir >> dir_list.txt
        done

        sort dir_list.txt | uniq | tee dir_list_uniq.txt

        for dir in $(cat dir_list_uniq.txt); do
          SUBSTITUTIONS=""
          SUBSTITUTIONS+="_DIR=$dir,_PROJECT_BUCKET=$_PROJECT_BUCKET,_RUN_TF_PLAN=$_RUN_TF_PLAN,_RUN_TF_FMT=$_RUN_TF_FMT,"
          SUBSTITUTIONS+="_RUN_TF_DOCS=$_RUN_TF_DOCS,_RUN_TF_LINT=$_RUN_TF_LINT,_RUN_TF_SEC=$_RUN_TF_SEC,_RUN_TF_OPA=$_RUN_TF_OPA,"
          SUBSTITUTIONS+="_RUN_TF_CHECKOV=$_RUN_TF_CHECKOV,_TF_VERSION=$_TF_VERSION,_TFDOCS_VERSION=$_TFDOCS_VERSION,_TFLINT_VERSION=$_TFLINT_VERSION,"
          SUBSTITUTIONS+="_TFSEC_VERSION=$_TFSEC_VERSION,_TFOPA_VERSION=$_TFOPA_VERSION,_TFCHECKOV_VERSION=$_TFCHECKOV_VERSION,_SHOW_README=$_SHOW_README,"
          SUBSTITUTIONS+="_SKIP_ERRORS=$_SKIP_ERRORS,_LOGS_BUCKET=$_LOGS_BUCKET,_SERVICE_ACCOUNT=$_SERVICE_ACCOUNT"

          gcloud builds submit --config /workspace/modules/tf-audit/cloudbuild.yaml ./ --substitutions $$SUBSTITUTIONS \
            --impersonate-service-account=$_SERVICE_ACCOUNT &
          PID+="$$! "
          sleep 1
        done
        
        wait $$PID
    dir: tf-audit
    id: Generate report
    entrypoint: bash
    secretEnv:
      - GIT_TOKEN
substitutions:
  _PROJECT_BUCKET: '${PROJECT_ID}-tf'
  _RUN_TF_PLAN: 'true'
  _RUN_TF_FMT: 'true'
  _RUN_TF_DOCS: 'true'
  _RUN_TF_LINT: 'true'
  _RUN_TF_SEC: 'true'
  _RUN_TF_OPA: 'true'
  _RUN_TF_CHECKOV: 'true'
  _TF_VERSION: 1.1.3
  _TFDOCS_VERSION: 0.16.0
  _TFLINT_VERSION: 0.43.0
  _TFSEC_VERSION: 1.28.1
  _TFOPA_VERSION: 0.46.1
  _TFCHECKOV_VERSION: 2.2.114
  _SHOW_README: 'false'
  _SKIP_ERRORS: 'true'
  _LOGS_BUCKET: ''
  _SERVICE_ACCOUNT: ''
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/git-token/versions/latest
      env: GIT_TOKEN
options:
  logging: GCS_ONLY
logsBucket: gs://$_LOGS_BUCKET
serviceAccount: projects/$PROJECT_ID/serviceAccounts/$_SERVICE_ACCOUNT
